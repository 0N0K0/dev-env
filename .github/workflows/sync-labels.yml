name: Sync Labels

on:
    workflow_dispatch:

jobs:
  sync-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Download GitHub CLI
        run: |
          curl -sSL https://github.com/cli/cli/releases/latest/download/gh_2.50.0_linux_amd64.tar.gz -o gh.tar.gz
          tar -xzf gh.tar.gz
          sudo cp gh_2.50.0_linux_amd64/bin/gh /usr/local/bin/

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Remove all existing labels
        run: |
          echo "Suppression des labels existants dans $GITHUB_REPOSITORY..."
          for label in $(gh label list -R "$GITHUB_REPOSITORY" --json name -q '.[].name'); do
            gh label delete "$label" -R "$GITHUB_REPOSITORY" -y || true
          done

      - name: Sync labels from template
        run: |
          TEMPLATE_REPO="0N0K0/dev-env"

          echo "Récupération des labels depuis $TEMPLATE_REPO..."
          for label in $(gh label list -R "$TEMPLATE_REPO" --json name,color,description -q '.[] | @base64'); do
            _jq() {
              echo "$label" | base64 --decode | jq -r "$1"
            }

            name=$(_jq '.name')
            color=$(_jq '.color')
            description=$(_jq '.description')

            echo "Création du label : $name"
            gh label create "$name" --color "$color" --description "$description" -R "$GITHUB_REPOSITORY" || true
          done
